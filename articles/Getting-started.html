<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="tft">
<title>Getting started • tft</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Getting started">
<meta property="og:description" content="tft">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">tft</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Getting-started.html">Getting started</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Getting started</h1>
            
      
      
      <div class="d-none name"><code>Getting-started.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org" class="external-link">tidymodels</a></span><span class="op">)</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlverse.github.io/tft/">tft</a></span><span class="op">)</span></code></pre></div>
<p>tft is an R implementation of Temporal Fusion Transformers (TFT) using the torch package. The Temporal Fusion Transformer is a neural network architecture proposed by Bryan Lim et al. with the goal of making interpretable multi-horizon time-series forecasts.</p>
<p>The R package tft abstracts away the details of the architecture and provides an API that allows easy experimenting with the TFT architecture.</p>
<p>In this article we will create forecasts for the <code>?walmart_sales_weekly</code> dataset included in the <a href="https://github.com/dfalbel/walmartdata" class="external-link">walmartdata</a> package. This dataset has weekly sales of a sample of weekly sales by department of 45 retail stores. It also includes a few external predictors like the temperature, fuel price and the size of the store.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">walmart_sales</span>, package <span class="op">=</span> <span class="st">"walmartdata"</span><span class="op">)</span>
<span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">walmart_sales</span><span class="op">)</span>
<span class="co">#&gt; Rows: 421,570</span>
<span class="co">#&gt; Columns: 16</span>
<span class="co">#&gt; $ Store        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …</span>
<span class="co">#&gt; $ Dept         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …</span>
<span class="co">#&gt; $ Date         <span style="color: #949494; font-style: italic;">&lt;date&gt;</span> 2010-02-05, 2010-02-12, 2010-02-19, 2010-02-26, 2010-03-…</span>
<span class="co">#&gt; $ Weekly_Sales <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 24924.50, 46039.49, 41595.55, 19403.54, 21827.90, 21043.3…</span>
<span class="co">#&gt; $ Type         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "A", "A", "A", "A", "A", "A", "A", "A", "A", "A", "A", "A…</span>
<span class="co">#&gt; $ Size         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 151315, 151315, 151315, 151315, 151315, 151315, 151315, 1…</span>
<span class="co">#&gt; $ Temperature  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 42.31, 38.51, 39.93, 46.63, 46.50, 57.79, 54.58, 51.45, 6…</span>
<span class="co">#&gt; $ Fuel_Price   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 2.572, 2.548, 2.514, 2.561, 2.625, 2.667, 2.720, 2.732, 2…</span>
<span class="co">#&gt; $ MarkDown1    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…</span>
<span class="co">#&gt; $ MarkDown2    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…</span>
<span class="co">#&gt; $ MarkDown3    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…</span>
<span class="co">#&gt; $ MarkDown4    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…</span>
<span class="co">#&gt; $ MarkDown5    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…</span>
<span class="co">#&gt; $ CPI          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 211.0964, 211.2422, 211.2891, 211.3196, 211.3501, 211.380…</span>
<span class="co">#&gt; $ Unemployment <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 8.106, 8.106, 8.106, 8.106, 8.106, 8.106, 8.106, 8.106, 7…</span>
<span class="co">#&gt; $ IsHoliday    <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span> FALSE, TRUE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FA…</span></code></pre></div>
<div class="section level2">
<h2 id="preparing-the-data">Preparing the data<a class="anchor" aria-label="anchor" href="#preparing-the-data"></a>
</h2>
<p>tft uses the tsibble to specify time time columns and keys - when you want to create forecasts for multiple timeseries in a single model. So let’s first, transform the <code>data.frame</code> into a <code>tbl_ts</code>.</p>
<p>We have weekly observations for each Store and Department, but since Type and Size are informations that don’t vary on time we have also added them as ‘keys’ for <code>tsibble</code>. We specify the index column as the <code>Date</code> column.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sales</span> <span class="op">&lt;-</span> <span class="fu">tsibble</span><span class="fu">::</span><span class="fu"><a href="https://tsibble.tidyverts.org/reference/tsibble.html" class="external-link">tsibble</a></span><span class="op">(</span>
  <span class="va">walmart_sales</span>, key <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">Store</span>, <span class="va">Dept</span>, <span class="va">Type</span>, <span class="va">Size</span><span class="op">)</span>, 
  index <span class="op">=</span> <span class="va">Date</span>
<span class="op">)</span>
<span class="va">sales</span>
<span class="co">#&gt; <span style="color: #949494;"># A tsibble: 421,570 x 16 [7D]</span></span>
<span class="co">#&gt; <span style="color: #949494;"># Key:       Store, Dept, Type, Size [3,331]</span></span>
<span class="co">#&gt;    Store  Dept Date       Weekly_Sales Type    Size Temperature Fuel_Price</span>
<span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1     1 2010-02-05       <span style="text-decoration: underline;">24</span>924. A     <span style="text-decoration: underline;">151</span>315        42.3       2.57</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     1     1 2010-02-12       <span style="text-decoration: underline;">46</span>039. A     <span style="text-decoration: underline;">151</span>315        38.5       2.55</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     1     1 2010-02-19       <span style="text-decoration: underline;">41</span>596. A     <span style="text-decoration: underline;">151</span>315        39.9       2.51</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     1     1 2010-02-26       <span style="text-decoration: underline;">19</span>404. A     <span style="text-decoration: underline;">151</span>315        46.6       2.56</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     1     1 2010-03-05       <span style="text-decoration: underline;">21</span>828. A     <span style="text-decoration: underline;">151</span>315        46.5       2.62</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     1     1 2010-03-12       <span style="text-decoration: underline;">21</span>043. A     <span style="text-decoration: underline;">151</span>315        57.8       2.67</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     1     1 2010-03-19       <span style="text-decoration: underline;">22</span>137. A     <span style="text-decoration: underline;">151</span>315        54.6       2.72</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     1     1 2010-03-26       <span style="text-decoration: underline;">26</span>229. A     <span style="text-decoration: underline;">151</span>315        51.4       2.73</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     1     1 2010-04-02       <span style="text-decoration: underline;">57</span>258. A     <span style="text-decoration: underline;">151</span>315        62.3       2.72</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     1     1 2010-04-09       <span style="text-decoration: underline;">42</span>961. A     <span style="text-decoration: underline;">151</span>315        65.9       2.77</span>
<span class="co">#&gt; <span style="color: #949494;"># … with 421,560 more rows, and 8 more variables: MarkDown1 &lt;dbl&gt;,</span></span>
<span class="co">#&gt; <span style="color: #949494;">#   MarkDown2 &lt;dbl&gt;, MarkDown3 &lt;dbl&gt;, MarkDown4 &lt;dbl&gt;, MarkDown5 &lt;dbl&gt;,</span></span>
<span class="co">#&gt; <span style="color: #949494;">#   CPI &lt;dbl&gt;, Unemployment &lt;dbl&gt;, IsHoliday &lt;lgl&gt;</span></span></code></pre></div>
<p><code>tsibble</code> correctly identifies the weekly period (<code>[7D]</code>) and shows us that we have 3331 different time series that we want to create predictions to.</p>
<p>tft also uses the <a href="https://github.com/tidymodels/recipes" class="external-link">recipes</a> ppackage to specify the response variables, the predictors and their types. We can also use recipes to specify transformations on the data that will be used by the model.</p>
<p>By default the keys of the the tsibble are considered as ‘static’ predictors, ie, they don’t vary on time for each time series. You can remove the role ‘predictor’ from it if you don’t want it to be used as a predictor.</p>
<p>We can also have ‘known’ predictors: these vary on time but in a regular way thus we can compute them for each time step, even for future ones - like the ‘IsHoliday’ and information like the day of the week and other similar. We expect you to be able to specify them for every time point when using the <code>forecast</code> function.</p>
<p>The index variable is not used in the model, unless transformed. All other predictors are considered ‘observed’ predictors and thus only ‘past’ values will be used in the model. Past values of the response variable are also used as ‘observed’ values in the model.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">Weekly_Sales</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">sales</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/roles.html" class="external-link">add_role</a></span><span class="op">(</span><span class="va">IsHoliday</span>, new_role <span class="op">=</span> <span class="st">"known"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_date.html" class="external-link">step_date</a></span><span class="op">(</span><span class="va">Date</span>, role <span class="op">=</span> <span class="st">"known"</span>, features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"year"</span>, <span class="st">"month"</span>, <span class="st">"doy"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_normalize.html" class="external-link">step_normalize</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html" class="external-link">all_numeric_predictors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_indicate_na.html" class="external-link">step_indicate_na</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"MarkDown"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_impute_mean.html" class="external-link">step_impute_mean</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"Markdown"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>It’s recommended to include features that represent seasonality as known predictors in the TFT model, like mon, day of the week and etc. It’s also recommended to normalize the predictors and treat missing values as the model don’t treat them implicitly.</p>
<p>You can bake <code>prep</code> and <code>juice</code> the recipe to see how the transformations are working:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rec</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/juice.html" class="external-link">juice</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Rows: 421,570</span>
<span class="co">#&gt; Columns: 24</span>
<span class="co">#&gt; $ Store            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -1.658197, -1.658197, -1.658197, -1.658197, -1.658197…</span>
<span class="co">#&gt; $ Dept             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -1.418741, -1.418741, -1.418741, -1.418741, -1.418741…</span>
<span class="co">#&gt; $ Date             <span style="color: #949494; font-style: italic;">&lt;date&gt;</span> 2010-02-05, 2010-02-12, 2010-02-19, 2010-02-26, 2010…</span>
<span class="co">#&gt; $ Type             <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> A, A, A, A, A, A, A, A, A, A, A, A, A, A, A, A, A, A,…</span>
<span class="co">#&gt; $ Size             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.2392087, 0.2392087, 0.2392087, 0.2392087, 0.2392087…</span>
<span class="co">#&gt; $ Temperature      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -0.9637969, -1.1697821, -1.0928087, -0.7296243, -0.73…</span>
<span class="co">#&gt; $ Fuel_Price       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -1.720832, -1.773175, -1.847328, -1.744823, -1.605241…</span>
<span class="co">#&gt; $ MarkDown1        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1.401583e-17, 1.401583e-17, 1.401583e-17, 1.401583e-1…</span>
<span class="co">#&gt; $ MarkDown2        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -1.457308e-17, -1.457308e-17, -1.457308e-17, -1.45730…</span>
<span class="co">#&gt; $ MarkDown3        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 9.280565e-19, 9.280565e-19, 9.280565e-19, 9.280565e-1…</span>
<span class="co">#&gt; $ MarkDown4        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 7.901976e-18, 7.901976e-18, 7.901976e-18, 7.901976e-1…</span>
<span class="co">#&gt; $ MarkDown5        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 6.785472e-17, 6.785472e-17, 6.785472e-17, 6.785472e-1…</span>
<span class="co">#&gt; $ CPI              <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1.0187730, 1.0224965, 1.0236961, 1.0244749, 1.0252538…</span>
<span class="co">#&gt; $ Unemployment     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.07820083, 0.07820083, 0.07820083, 0.07820083, 0.078…</span>
<span class="co">#&gt; $ IsHoliday        <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span> FALSE, TRUE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE…</span>
<span class="co">#&gt; $ Weekly_Sales     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 24924.50, 46039.49, 41595.55, 19403.54, 21827.90, 210…</span>
<span class="co">#&gt; $ Date_year        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 2010, 2010, 2010, 2010, 2010, 2010, 2010, 2010, 2010,…</span>
<span class="co">#&gt; $ Date_month       <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> Feb, Feb, Feb, Feb, Mar, Mar, Mar, Mar, Apr, Apr, Apr…</span>
<span class="co">#&gt; $ Date_doy         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 36, 43, 50, 57, 64, 71, 78, 85, 92, 99, 106, 113, 120…</span>
<span class="co">#&gt; $ na_ind_MarkDown1 <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…</span>
<span class="co">#&gt; $ na_ind_MarkDown2 <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…</span>
<span class="co">#&gt; $ na_ind_MarkDown3 <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…</span>
<span class="co">#&gt; $ na_ind_MarkDown4 <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…</span>
<span class="co">#&gt; $ na_ind_MarkDown5 <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="metrics-and-validation">Metrics and validation<a class="anchor" aria-label="anchor" href="#metrics-and-validation"></a>
</h2>
<p>Now we should think about the size of the horizon we want to create forecasts to. It could be a single week ahead or ten, and this will influence how we split our data for training, validation and testing. This is not really a data analysis decision but more of a business decision, ie: how many weeks ahead we want know so we can plan the demand and etc. Let’s say we want 4 weeks ahead, ie ~1 month.</p>
<p>The <a href="https://github.com/tidymodels/rsample" class="external-link">rsample</a> package provides <code>sliding_*</code> functions that are very useful for the task of creating time splits.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resamples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/slide-resampling.html" class="external-link">sliding_period</a></span><span class="op">(</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">sales</span>, <span class="va">Date</span><span class="op">)</span>,
  index <span class="op">=</span> <span class="va">Date</span>,
  period <span class="op">=</span> <span class="st">"week"</span>,
  lookback <span class="op">=</span> <span class="cn">Inf</span>,
  assess_stop <span class="op">=</span> <span class="fl">4</span>,
  step <span class="op">=</span> <span class="fl">4</span>,
  skip <span class="op">=</span> <span class="fl">104</span>
<span class="op">)</span></code></pre></div>
<p>Now we can separate the splits in, training and testing, ie: a few of them will be used for cross-validation and choosing the hyperparamerters, the others are used for testing the model. We are going to use the last 4 splits for testing and the first 5 to cross validate.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">train_splits</span> <span class="op">&lt;-</span> <span class="va">resamples</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>
<span class="va">test_splits</span> <span class="op">&lt;-</span> <span class="va">resamples</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><strong>Note</strong>: we have selected 4 weeks as the horizon of our predictions. We need to use this same value when specifying the horizon for the tft model.</p>
</div>
<div class="section level2">
<h2 id="fitting-the-model">Fitting the model<a class="anchor" aria-label="anchor" href="#fitting-the-model"></a>
</h2>
<p>We can now tune the tft model and compute metrics using:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">rec</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">add_model</span><span class="op">(</span><span class="fu">tft</span><span class="op">(</span>horizon <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>

<span class="va">grid</span> <span class="op">&lt;-</span> <span class="fu">grid_regular</span><span class="op">(</span><span class="va">model</span>, levels <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>

<span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">tune_grid</span><span class="op">(</span>
  <span class="va">model</span>,
  <span class="va">resamples</span>,
  <span class="va">grid</span>
<span class="op">)</span>

<span class="fu">collect_metrics</span><span class="op">(</span><span class="va">results</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 4</span></span>
<span class="co">#&gt;   epochs hidden_layer_size training_tau   rmse</span>
<span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span>      1               160        0.3   0.295 </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span>      5               500        0.003 0.021<span style="text-decoration: underline;">8</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span>      7               300        0.1   0.545 </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">4</span>      1               160        0.5   0.465 </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">5</span>      5               500        0.003 0.954</span></code></pre>
<p>Once you are happy with the tuning you can finalize the workflow and obtain the metrics for the test splits.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">final_params</span> <span class="op">&lt;-</span> <span class="fu">select_best</span><span class="op">(</span><span class="va">results</span>, metric <span class="op">=</span> <span class="st">"rmse"</span><span class="op">)</span>
<span class="va">workflow</span> <span class="op">&lt;-</span> <span class="fu">finalize_workflow</span><span class="op">(</span><span class="va">model</span>, <span class="va">final_params</span><span class="op">)</span>
<span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">fit_resamples</span><span class="op">(</span><span class="va">model</span>, <span class="va">test_splits</span><span class="op">)</span>
<span class="fu">collect_metrics</span><span class="op">(</span><span class="va">results</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 2</span></span>
<span class="co">#&gt;   metric value</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> rmse   0.001</span></code></pre>
<p>To obtain predictions for future observations, first we need to load a data.frame that includes known predictors like the <code>IsHoliday</code> variable for all time steps in the future data frame. Then we can call <code>forecast</code> or <code>predict</code> to obtain the predictions for the future data.</p>
<p>Note that <code>forecast</code> or <code>predict</code> currently can only predict for <code>horizon</code> time steps ahead. And don’t provide a away for doing rolling forecasts.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">final_model</span> <span class="op">&lt;-</span> <span class="fu">fit</span><span class="op">(</span><span class="va">model</span>, <span class="va">sales</span><span class="op">)</span>
<span class="va">final_predictions</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="op">(</span><span class="va">model</span>, new_data <span class="op">=</span> <span class="va">newdata</span><span class="op">)</span>
<span class="va">final_predictions</span></code></pre></div>
<pre><code><span class="co">#&gt; <span style="color: #949494;"># A tsibble: 13,324 x 6 [7D]</span></span>
<span class="co">#&gt; <span style="color: #949494;"># Key:       Store, Dept, Type, Size [3,331]</span></span>
<span class="co">#&gt;    Store  Dept Date       Type    Size  .pred</span>
<span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1     1 2012-11-02 A     <span style="text-decoration: underline;">151</span>315   311.</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     1     1 2012-11-09 A     <span style="text-decoration: underline;">151</span>315  <span style="text-decoration: underline;">4</span>421.</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     1     1 2012-11-16 A     <span style="text-decoration: underline;">151</span>315 <span style="text-decoration: underline;">11</span>085.</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     1     1 2012-11-23 A     <span style="text-decoration: underline;">151</span>315  <span style="text-decoration: underline;">7</span>216.</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     1     2 2012-11-02 A     <span style="text-decoration: underline;">151</span>315  <span style="text-decoration: underline;">1</span>474.</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     1     2 2012-11-09 A     <span style="text-decoration: underline;">151</span>315 <span style="text-decoration: underline;">33</span>240.</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     1     2 2012-11-16 A     <span style="text-decoration: underline;">151</span>315  <span style="text-decoration: underline;">2</span>639.</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     1     2 2012-11-23 A     <span style="text-decoration: underline;">151</span>315  <span style="text-decoration: underline;">1</span>472.</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     1     3 2012-11-02 A     <span style="text-decoration: underline;">151</span>315  <span style="text-decoration: underline;">4</span>877.</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     1     3 2012-11-09 A     <span style="text-decoration: underline;">151</span>315 <span style="text-decoration: underline;">27</span>584.</span>
<span class="co">#&gt; <span style="color: #949494;"># … with 13,314 more rows</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Daniel Falbel, Christophe Regouby.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
