<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="tft">
<title>Getting started • tft</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Getting started">
<meta property="og:description" content="tft">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">tft</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Electricity-dataset.html">Electricity dataset</a>
    <a class="dropdown-item" href="../articles/Getting-started.html">Getting started</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Getting started</h1>
            
      
      
      <div class="d-none name"><code>Getting-started.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org" class="external-link">tidymodels</a></span><span class="op">)</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlverse.github.io/tft/">tft</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_manual_seed.html" class="external-link">torch_manual_seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></code></pre></div>
<p>tft is an R implementation of Temporal Fusion Transformers (TFT) using the torch package. The Temporal Fusion Transformer is a neural network architecture proposed by Bryan Lim et al. with the goal of making multi-horizon time series forecasts for multiple time series in a single model.</p>
<p>The main difference between TFT and conventional forecasting methodologies is the way its architecture allows encoding different types of input data that can exist in forecasting problems. For instance, the model allows handling static covariates and time varying (known and unknown) differently.</p>
<p>TFT announcement shows <a href="https://ai.googleblog.com/2021/12/interpretable-deep-learning-for-time.html" class="external-link">promising benchmarks</a> in forecasting performance for a variety of datasets.</p>
<p>The R package <strong>tft</strong> abstracts away the details of the architecture and provides an API that allows easy experimenting with the TFT architecture.</p>
<p>In this article we will create forecasts for the <a href="https://github.com/beatrizmilz/mananciais" class="external-link">‘mananciais’ dataset</a>. This dataset includes daily level information for a set of 7 water reservoirs that supply the São Paulo metropolitan region in Brazil.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mananciais</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv2</a></span><span class="op">(</span><span class="st">"https://github.com/beatrizmilz/mananciais/raw/a2d1d8b04cbd3a3a71836a4849d90a5e024e5180/inst/extdata/mananciais.csv"</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Using <span style="color: #0000BB;">"','"</span> as decimal and <span style="color: #0000BB;">"'.'"</span> as grouping mark. Use `read_delim()` for more control.</span>
<span class="co">#&gt; <span style="font-weight: bold;">Rows: </span><span style="color: #0000BB;">50654</span> <span style="font-weight: bold;">Columns: </span><span style="color: #0000BB;">8</span></span>
<span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">Column specification</span> <span style="color: #00BBBB;">────────────────────────────────────────────────────────</span></span>
<span class="co">#&gt; <span style="font-weight: bold;">Delimiter:</span> ";"</span>
<span class="co">#&gt; <span style="color: #BB0000;">chr</span>  (1): sistema</span>
<span class="co">#&gt; <span style="color: #00BB00;">dbl</span>  (6): volume_porcentagem, volume_variacao, volume_operacional, pluviomet...</span>
<span class="co">#&gt; <span style="color: #0000BB;">date</span> (1): data</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Use `spec()` to retrieve the full column specification for this data.</span>
<span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Specify the column types or set `show_col_types = FALSE` to quiet this message.</span>

<span class="co"># translate column names</span>
<span class="va">reservoirs</span> <span class="op">&lt;-</span> <span class="va">mananciais</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">select</span><span class="op">(</span>
    date <span class="op">=</span> <span class="va">data</span>,
    system <span class="op">=</span> <span class="va">sistema</span>,
    volume_percentage <span class="op">=</span> <span class="va">volume_porcentagem</span>,   <span class="co"># volume in % of total capacity</span>
    volume_variation <span class="op">=</span> <span class="va">volume_variacao</span>,       <span class="co"># % variation from the day before</span>
    volume_operational <span class="op">=</span> <span class="va">volume_operacional</span>,  <span class="co"># operational volume in hm3</span>
    pluviometric_daily <span class="op">=</span> <span class="va">pluviometria_dia</span>,    <span class="co"># pluviometrics daily in mm</span>
    pluviometric_month <span class="op">=</span> <span class="va">pluviometria_mensal</span>, <span class="co"># accumulated pluviometrics monthly</span>
    pluviometric_hist <span class="op">=</span> <span class="va">pluviometria_hist</span>     <span class="co"># mean historical pluviometrics</span>
  <span class="op">)</span>
<span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">reservoirs</span><span class="op">)</span>
<span class="co">#&gt; Rows: 50,654</span>
<span class="co">#&gt; Columns: 8</span>
<span class="co">#&gt; $ date               <span style="color: #949494; font-style: italic;">&lt;date&gt;</span> 2022-05-24, 2022-05-24, 2022-05-24, 2022-05-24, 20…</span>
<span class="co">#&gt; $ system             <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "Cantareira", "Alto Tietê", "Guarapiranga", "Cotia"…</span>
<span class="co">#&gt; $ volume_percentage  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 42.2, 62.8, 80.9, 85.7, 99.7, 43.8, 93.3, 42.3, 63.…</span>
<span class="co">#&gt; $ volume_variation   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -0.1, -0.2, -0.3, -0.2, -0.2, -0.1, -0.3, -0.1, -0.…</span>
<span class="co">#&gt; $ volume_operational <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 414.31772, 351.98456, 138.51027, 14.13465, 111.8011…</span>
<span class="co">#&gt; $ pluviometric_daily <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.0, 0.1, 0.2, 0.2, 0.2, 1.0, 0.0, 0.1, 0.2, 0.0, 0…</span>
<span class="co">#&gt; $ pluviometric_month <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 31.6, 31.3, 9.0, 6.0, 12.4, 55.0, 34.8, 31.6, 31.2,…</span>
<span class="co">#&gt; $ pluviometric_hist  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 74.8, 69.4, 59.6, 64.6, 79.9, 132.6, 88.9, 74.8, 69…</span></code></pre></div>
<div class="section level2">
<h2 id="preparing-the-data">Preparing the data<a class="anchor" aria-label="anchor" href="#preparing-the-data"></a>
</h2>
<p>We first display the data for the 7 reservoirs:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">reservoirs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">volume_percentage</span>, color <span class="op">=</span> <span class="va">system</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="Getting-started_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<p>To reduce computation time and make the model more useful, we are going to aggregate the data into weekly intervals. This will leave us with a much smaller dataset, which should make the model much faster to train. It also allows us to choose a larger horizon.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">reservoirs</span> <span class="op">&lt;-</span> <span class="va">reservoirs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">mutate</span><span class="op">(</span>date <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/round_date.html" class="external-link">floor_date</a></span><span class="op">(</span><span class="va">date</span>, unit <span class="op">=</span> <span class="st">"week"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">group_by</span><span class="op">(</span><span class="va">date</span>, <span class="va">system</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">summarise</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu">everything</span><span class="op">(</span><span class="op">)</span>, .fns <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">.x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span></code></pre></div>
<p>We used the mean o aggregate all variables even though the <code>volume_variation</code> is now much harder to interpret. The new dataset looks like:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">reservoirs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">volume_percentage</span>, color <span class="op">=</span> <span class="va">system</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="Getting-started_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>The level can go below the 0%, this means that water from a so called <a href="https://pt.wikipedia.org/wiki/Volume_morto" class="external-link">‘technical water reserve’</a>, ie water from below the level of the usual water pipes has been used. This happened during the <a href="https://en.wikipedia.org/wiki/2014%E2%80%932017_Brazilian_drought" class="external-link">severe drought</a> the hit the region between 2014 and 2017.</p>
<p>Our goal is to predict the reservoir level for the 3 months (12 weeks to be more precise). We will split the dataset in 3 parts. The last 3 months for testing, the previous 3 for validation and the rest for training the model.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">last_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">reservoirs</span><span class="op">$</span><span class="va">date</span><span class="op">)</span>
<span class="va">train</span> <span class="op">&lt;-</span> <span class="va">reservoirs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">&lt;=</span> <span class="op">(</span><span class="va">last_date</span> <span class="op">-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">weeks</a></span><span class="op">(</span><span class="fl">48</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">valid</span> <span class="op">&lt;-</span> <span class="va">reservoirs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">&gt;</span> <span class="op">(</span><span class="va">last_date</span> <span class="op">-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">weeks</a></span><span class="op">(</span><span class="fl">48</span><span class="op">)</span><span class="op">)</span>,
                                <span class="va">date</span> <span class="op">&lt;=</span> <span class="op">(</span><span class="va">last_date</span> <span class="op">-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">weeks</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">test</span> <span class="op">&lt;-</span> <span class="va">reservoirs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">&gt;</span> <span class="op">(</span><span class="va">last_date</span> <span class="op">-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">weeks</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Now that the data is prepared we will create a preprocessing pipeline using the recipes package. This recipe will allow handling normalization of covariates - which is very important in neural network models. It also adds a few covariates that are recommended by the paper authors like <code>time_since_begining</code>and categoricals for month and week in the year.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu">recipe</span><span class="op">(</span><span class="va">volume_percentage</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">train</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">step_mutate</span><span class="op">(</span>
    time_since_begining <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span>
      time1 <span class="op">=</span> <span class="va">date</span>, 
      time2 <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html" class="external-link">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">reservoirs</span><span class="op">$</span><span class="va">date</span><span class="op">)</span><span class="op">)</span>, 
      units <span class="op">=</span> <span class="st">"weeks"</span>
    <span class="op">)</span><span class="op">)</span>,
    date_week <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/week.html" class="external-link">week</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span>,
    date_month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html" class="external-link">month</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span>,
    date_wday <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html" class="external-link">wday</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">step_impute_mean</span><span class="op">(</span><span class="va">pluviometric_hist</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">step_normalize</span><span class="op">(</span><span class="fu">all_numeric_predictors</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="specifying-the-covariates">Specifying the covariates<a class="anchor" aria-label="anchor" href="#specifying-the-covariates"></a>
</h2>
<p>Like we said earlier, TFT allows encoding covariates differently in the architecture. There are 5 possible ways tft can treat columns in the dataset that we summarise below:</p>
<ul>
<li>
<strong>‘index’</strong>: is a single date column that specifies at which point in time the observation refers to. This is not directly used by the model itself, but is used internally to create rolling windows and order observations.</li>
<li>
<strong>‘key’</strong>: are groups of columns that identify a single time series. Keys are necessary if you are creating predictions for multiple time series in a single model. By default, ‘keys’ are also considered ‘static’ predictors by the model.</li>
<li>
<strong>‘static’</strong>: predictors are considered ‘static’ when they don’t vary over time, they are information from the time-series, like a region or a kind of product.</li>
<li>
<strong>‘unknown’</strong> are predictors that vary over time but we only know values observed for past observations. For example, you can use the daily temperature as a predictor, but you only know it for past observations.</li>
<li>
<strong>‘known’</strong> are predictors that vary over time and are known even for future observations. For example, the day of the week can be used as a predictor for a daily time series, and it’s known for every time step, no matter if it’s from past or future.</li>
</ul>
<p>To specify the role of each covariate in the model we use the <code><a href="../reference/tft_dataset_spec.html">tft_dataset_spec()</a></code> function. This interface has a similar intent as recipes (in tidymodels), ie. it allows you to reproduce the same preprocessing to a different dataset later - which is useful when you want to create forecasts.</p>
<p>Also part of the dataset specification is the history size the model will use to make predictions and the size of the horizon (ie how many time-steps ahead) we want to generate predictions. Consider the following diagram to represent the time series</p>
<div class="figure">
<img src="img/time-series.png" alt=""><p class="caption">Time series</p>
</div>
<p>tft feeds data to the model in slices that have a fixed history size, that we call <code>lookback</code> and a fixed number of timesteps ahead that we are calling <code>horizon</code>. Those are represented in the diagram below:</p>
<div class="figure">
<img src="img/slices.png" alt=""><p class="caption">Slices</p>
</div>
<p>Now lets create the tft dataset specification. We don’t need to manually specfy the <code>unknown</code> covariates as, unmentioned variables are automatically treated as such.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tft_dataset_spec.html">tft_dataset_spec</a></span><span class="op">(</span><span class="va">rec</span>, <span class="va">train</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/tft_dataset_spec.html">spec_covariate_index</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/tft_dataset_spec.html">spec_covariate_key</a></span><span class="op">(</span><span class="va">system</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/tft_dataset_spec.html">spec_covariate_known</a></span><span class="op">(</span><span class="va">time_since_begining</span>, <span class="fu">starts_with</span><span class="op">(</span><span class="st">"date_"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The print method for <code>spec</code> shows useful information about the specification:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">spec</span>
<span class="co">#&gt; A <span style="color: #0000BB;">&lt;tft_dataset_spec&gt;</span> with:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; <span style="color: #BB0000;">✖</span> `lookback` and `horizon` are not set. Use `spec_time_splits()` </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ── Covariates: </span>
<span class="co">#&gt; <span style="color: #00BB00;">✔</span> `index`: date</span>
<span class="co">#&gt; <span style="color: #00BB00;">✔</span> `keys`: &lt;list: system&gt;</span>
<span class="co">#&gt; <span style="color: #BBBB00;">!</span> `static` is not set. Use `spec_covariate_static()` to set it.</span>
<span class="co">#&gt; <span style="color: #00BB00;">✔</span> `known`: &lt;list: time_since_begining, starts_with("date_")&gt;</span>
<span class="co">#&gt; <span style="color: #BBBB00;">!</span> `unknown` is not set. Covariates that are not listed as other types are considered `unknown`.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Call `prep()` to prepare the specification.</span></code></pre></div>
<p>Here we see that we didn’t specify the <code>lookback</code> and <code>horizon</code>, so let’s add it to the spec. The <code>lookback</code> usually works like any other hyperparameter and we in general choose values between 10 and 1000 depending on the time series period. Horizon is chosen to statisfy business needs, ie. if you want to have predictions for 30 days ahead, you should choose that.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">spec</span> <span class="op">&lt;-</span> <span class="va">spec</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/tft_dataset_spec.html">spec_time_splits</a></span><span class="op">(</span>lookback <span class="op">=</span> <span class="fl">5</span><span class="op">*</span><span class="fl">12</span>, horizon <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></code></pre></div>
<p>We now execute <code>prep</code> to prepare the <code>spec</code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prep.html">prep</a></span><span class="op">(</span><span class="va">spec</span><span class="op">)</span>
<span class="va">spec</span>
<span class="co">#&gt; A <span style="color: #0000BB;">&lt;prepared_tft_dataset_spec&gt;</span> with:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; <span style="color: #00BB00;">✔</span> lookback = 60 and horizon = 12.</span>
<span class="co">#&gt; <span style="color: #00BB00;">✔</span> The number of possible slices is 6,413</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ── Covariates: </span>
<span class="co">#&gt; <span style="color: #00BB00;">✔</span> `index`: date</span>
<span class="co">#&gt; <span style="color: #00BB00;">✔</span> `keys`: system</span>
<span class="co">#&gt; <span style="color: #00BB00;">✔</span> `static`: </span>
<span class="co">#&gt; <span style="color: #00BB00;">✔</span> `known`: time_since_begining, date_week, date_month, and date_wday</span>
<span class="co">#&gt; <span style="color: #00BB00;">✔</span> `unknown`: volume_variation, volume_operational, pluviometric_daily, pluviometric_month, and pluviometric_hist</span>
<span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Variables that are not specified in other types are considered `unknown`.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Call `transform()` to apply this spec to a different dataset.</span></code></pre></div>
<p>The print method now shows the name of all variables that will be used in the model and their role. Also shows information about the number of slices that will be used.</p>
</div>
<div class="section level2">
<h2 id="fitting-the-model">Fitting the model<a class="anchor" aria-label="anchor" href="#fitting-the-model"></a>
</h2>
<p>We will now fit our model. To that we first initialize the a model with:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/temporal_fusion_transformer.html">temporal_fusion_transformer</a></span><span class="op">(</span>
  <span class="va">spec</span>, 
  hidden_state_size <span class="op">=</span> <span class="fl">8</span>,
  learn_rate <span class="op">=</span> <span class="fl">1e-3</span>, 
  dropout <span class="op">=</span> <span class="fl">0.5</span>, 
  num_attention_heads <span class="op">=</span> <span class="fl">1</span>, 
  num_lstm_layers <span class="op">=</span> <span class="fl">1</span>
<span class="op">)</span>
<span class="va">model</span>
<span class="co">#&gt; &lt;luz_module_generator&gt;</span></code></pre></div>
<p><code>model</code> is a luz module, thus you can use luz workflows to train the model. For an example, you can use the <code>lr_finder</code> function to find the best learning rate for your model.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">luz</span><span class="fu">::</span><span class="fu"><a href="https://mlverse.github.io/luz/reference/lr_finder.html" class="external-link">lr_finder</a></span><span class="op">(</span>
  <span class="va">model</span>, 
  <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">spec</span>, <span class="va">train</span><span class="op">)</span>, 
  end_lr <span class="op">=</span> <span class="fl">1</span>,
  dataloader_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    batch_size <span class="op">=</span> <span class="fl">64</span>
  <span class="op">)</span>,
  verbose <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.15</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="Getting-started_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>This allows us to choose a learning rate. We will start with 1e-3. Let’s redefine the model now fixing the learning rate:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/temporal_fusion_transformer.html">temporal_fusion_transformer</a></span><span class="op">(</span>
  <span class="va">spec</span>, 
  hidden_state_size <span class="op">=</span> <span class="fl">8</span>,
  learn_rate <span class="op">=</span> <span class="fl">1e-3</span>, 
  dropout <span class="op">=</span> <span class="fl">0.5</span>, 
  num_attention_heads <span class="op">=</span> <span class="fl">1</span>, 
  num_lstm_layers <span class="op">=</span> <span class="fl">1</span>
<span class="op">)</span></code></pre></div>
<p>We can then fit the model using <code>fit</code>. Since <code>model</code> is a luz module we are mainly calling <code>?fit.luz_module_generator</code> here, so all arguments apply.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fitted</span> <span class="op">&lt;-</span> <span class="va">model</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/fit.html">fit</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">spec</span><span class="op">)</span>,
    valid_data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">spec</span>, new_data <span class="op">=</span> <span class="va">valid</span><span class="op">)</span>,
    epochs <span class="op">=</span> <span class="fl">100</span>,
    callbacks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
      <span class="fu">luz</span><span class="fu">::</span><span class="fu"><a href="https://mlverse.github.io/luz/reference/luz_callback_keep_best_model.html" class="external-link">luz_callback_keep_best_model</a></span><span class="op">(</span>monitor <span class="op">=</span> <span class="st">"valid_loss"</span><span class="op">)</span>,
      <span class="fu">luz</span><span class="fu">::</span><span class="fu"><a href="https://mlverse.github.io/luz/reference/luz_callback_early_stopping.html" class="external-link">luz_callback_early_stopping</a></span><span class="op">(</span>
        monitor <span class="op">=</span> <span class="st">"valid_loss"</span>, 
        patience <span class="op">=</span> <span class="fl">5</span>, 
        min_delta <span class="op">=</span> <span class="fl">0.001</span>
      <span class="op">)</span>
    <span class="op">)</span>,
    verbose <span class="op">=</span> <span class="cn">FALSE</span>,
    dataloader_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>batch_size <span class="op">=</span> <span class="fl">64</span>, num_workers <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
  <span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fitted</span><span class="op">)</span></code></pre></div>
<p><img src="Getting-started_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<p>We can evaluate the model in the test set using the <code><a href="https://mlverse.github.io/luz/reference/evaluate.html" class="external-link">luz::evaluate</a></code> function:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fitted</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">luz</span><span class="fu">::</span><span class="fu"><a href="https://mlverse.github.io/luz/reference/evaluate.html" class="external-link">evaluate</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">spec</span>, new_data <span class="op">=</span> <span class="va">test</span>, past_data <span class="op">=</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">train</span>, <span class="va">valid</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span>
<span class="co">#&gt; A `luz_module_evaluation`</span>
<span class="co">#&gt; ── Results ─────────────────────────────────────────────────────────────────────</span>
<span class="co">#&gt; loss: 0.129</span>
<span class="co">#&gt; q10: 0.0689</span>
<span class="co">#&gt; q50: 0.2039</span>
<span class="co">#&gt; q90: 0.1142</span></code></pre></div>
<p>Once we are happy with the results of our model we can make forecasts using the <code>forecast</code> function. The model we have trained can make predictions for at most 12 weeks ahead.</p>
<p>By default <code>forecast</code> generates predictions for the period right after the data the model has been trained. You can pass the <code>past_data</code> argument to make predictions for a more recent period.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="fu">generics</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span><span class="va">fitted</span>, past_data <span class="op">=</span> <span class="va">reservoirs</span><span class="op">)</span>
<span class="fu">glimpse</span><span class="op">(</span><span class="va">forecasts</span><span class="op">)</span>
<span class="co">#&gt; Rows: 84</span>
<span class="co">#&gt; Columns: 5</span>
<span class="co">#&gt; $ date        <span style="color: #949494; font-style: italic;">&lt;date&gt;</span> 2022-05-29, 2022-06-05, 2022-06-12, 2022-06-19, 2022-06-2…</span>
<span class="co">#&gt; $ system      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "Alto Tietê", "Alto Tietê", "Alto Tietê", "Alto Tietê", "A…</span>
<span class="co">#&gt; $ .pred_lower <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 61.81052, 60.57896, 60.71599, 59.16911, 58.93370, 57.35214…</span>
<span class="co">#&gt; $ .pred       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 61.98054, 61.79831, 62.08167, 60.99346, 60.87527, 60.34175…</span>
<span class="co">#&gt; $ .pred_upper <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 62.48463, 63.06790, 63.79862, 62.74385, 62.79102, 63.43890…</span></code></pre></div>
<p>The return value of <code>forecast</code> is a tibble containing predictions for each time serie in the 12 weeks ahead.</p>
<p>We can then show the predictions in a plot:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">reservoirs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">&gt;</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html" class="external-link">ymd</a></span><span class="op">(</span><span class="st">"2019-01-01"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">full_join</span><span class="op">(</span><span class="va">forecasts</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">volume_percentage</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">.pred</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_ribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">.pred_lower</span>, ymax <span class="op">=</span> <span class="va">.pred_upper</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">system</span><span class="op">)</span></code></pre></div>
<p><img src="Getting-started_files/figure-html/unnamed-chunk-18-1.png" width="700"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Daniel Falbel, Christophe Regouby.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
