<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="tft">
<title>Getting started • tft</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Getting started">
<meta property="og:description" content="tft">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">tft</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Electricity-dataset.html">Electricity dataset</a>
    <a class="dropdown-item" href="../articles/Getting-started.html">Getting started</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Getting started</h1>
            
      
      
      <div class="d-none name"><code>Getting-started.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org" class="external-link">tidymodels</a></span><span class="op">)</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlverse.github.io/tft/">tft</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_manual_seed.html" class="external-link">torch_manual_seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></code></pre></div>
<p>tft is an R implementation of Temporal Fusion Transformers (TFT) using the torch package. The Temporal Fusion Transformer is a neural network architecture proposed by Bryan Lim et al. with the goal of making multi-horizon time series forecasts for multiple time series in a single model.</p>
<p>The main difference between TFT and conventional forecasting methodologies is the way its architecture allows encoding different types of input data that can exist in forecasting problems. For instance, the model allows handling static covariates and time varying (known and unknown) differently.</p>
<p>TFT announcement shows <a href="https://ai.googleblog.com/2021/12/interpretable-deep-learning-for-time.html" class="external-link">promising benchmarks</a> in forecasting performance for a variety of datasets.</p>
<p>The R package <strong>tft</strong> abstracts away the details of the architecture and provides an API that allows easy experimenting with the TFT architecture.</p>
<p>In this article we will create forecasts for the <code>?walmart_sales_weekly</code> dataset included in the <a href="https://github.com/dfalbel/walmartdata" class="external-link">walmartdata</a> package. This dataset has weekly sales of a sample of weekly sales by department of 45 retail stores. It also includes a few external predictors like the temperature, fuel price and the size of the store.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">walmart_sales</span>, package <span class="op">=</span> <span class="st">"walmartdata"</span><span class="op">)</span>
<span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">walmart_sales</span><span class="op">)</span>
<span class="co">#&gt; Rows: 421,570</span>
<span class="co">#&gt; Columns: 16</span>
<span class="co">#&gt; $ Store        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …</span>
<span class="co">#&gt; $ Dept         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …</span>
<span class="co">#&gt; $ Date         <span style="color: #949494; font-style: italic;">&lt;date&gt;</span> 2010-02-05, 2010-02-12, 2010-02-19, 2010-02-26, 2010-03-…</span>
<span class="co">#&gt; $ Weekly_Sales <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 24924.50, 46039.49, 41595.55, 19403.54, 21827.90, 21043.3…</span>
<span class="co">#&gt; $ Type         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "A", "A", "A", "A", "A", "A", "A", "A", "A", "A", "A", "A…</span>
<span class="co">#&gt; $ Size         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 151315, 151315, 151315, 151315, 151315, 151315, 151315, 1…</span>
<span class="co">#&gt; $ Temperature  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 42.31, 38.51, 39.93, 46.63, 46.50, 57.79, 54.58, 51.45, 6…</span>
<span class="co">#&gt; $ Fuel_Price   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 2.572, 2.548, 2.514, 2.561, 2.625, 2.667, 2.720, 2.732, 2…</span>
<span class="co">#&gt; $ MarkDown1    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…</span>
<span class="co">#&gt; $ MarkDown2    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…</span>
<span class="co">#&gt; $ MarkDown3    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…</span>
<span class="co">#&gt; $ MarkDown4    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…</span>
<span class="co">#&gt; $ MarkDown5    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…</span>
<span class="co">#&gt; $ CPI          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 211.0964, 211.2422, 211.2891, 211.3196, 211.3501, 211.380…</span>
<span class="co">#&gt; $ Unemployment <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 8.106, 8.106, 8.106, 8.106, 8.106, 8.106, 8.106, 8.106, 7…</span>
<span class="co">#&gt; $ IsHoliday    <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span> FALSE, TRUE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FA…</span></code></pre></div>
<p>To make the example faster to run, we are going to create models for the first 2 stores and first 2 departments.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">walmart_sales</span> <span class="op">&lt;-</span> <span class="va">walmart_sales</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Store</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="va">Dept</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">92</span>, <span class="fl">95</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Store <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">Store</span><span class="op">)</span>, Dept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">Dept</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="section level2">
<h2 id="preparing-the-data">Preparing the data<a class="anchor" aria-label="anchor" href="#preparing-the-data"></a>
</h2>
<p>The first thing we need to make sure is that our dataset doesn’t have <a href="https://r4ds.hadley.nz/missing-values.html#missing-values" class="external-link">implicit missing observations</a>. This happens when an observations is just not present in the data instead of being explicitly marked with a <code>NA</code>. We are going to use <code>tsibble</code> functionality to add the implicitly missing observations, but you could use whatever tool you prefer for the task.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sales</span> <span class="op">&lt;-</span> <span class="va">walmart_sales</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu">tsibble</span><span class="fu">::</span><span class="fu"><a href="https://tsibble.tidyverts.org/reference/tsibble.html" class="external-link">tsibble</a></span><span class="op">(</span>
      key <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">Store</span>, <span class="va">Dept</span><span class="op">)</span>,
      index <span class="op">=</span> <span class="va">Date</span>
    <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu">tsibble</span><span class="fu">::</span><span class="fu"><a href="https://tsibble.tidyverts.org/reference/group_by_key.html" class="external-link">group_by_key</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu">tsibble</span><span class="fu">::</span><span class="fu"><a href="https://tsibble.tidyverts.org/reference/fill_gaps.html" class="external-link">fill_gaps</a></span><span class="op">(</span>
      Weekly_Sales <span class="op">=</span> <span class="fl">0</span>,
      IsHoliday <span class="op">=</span> <span class="cn">FALSE</span>
    <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/fill.html" class="external-link">fill</a></span><span class="op">(</span><span class="va">Size</span>, <span class="va">Temperature</span>, <span class="va">Fuel_Price</span>, <span class="va">CPI</span>, <span class="va">Unemployment</span>, .direction <span class="op">=</span> <span class="st">"down"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">feasts</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">sales</span>, <span class="va">Weekly_Sales</span><span class="op">)</span>
<span class="co">#&gt; `mutate_if()` ignored the following grouping variables:</span>
<span class="co">#&gt; <span style="color: #00BBBB;">•</span> Columns `Store`, `Dept`</span></code></pre></div>
<p><img src="Getting-started_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>We will also split the full dataset in 3 parts - training, validation and testing. We use the last 24 weeks of data for validation/testing - using 16 for validation and 8 of them for testing.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">last_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">sales</span><span class="op">$</span><span class="va">Date</span><span class="op">)</span>
<span class="va">sales_train</span> <span class="op">&lt;-</span> <span class="va">sales</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Date</span> <span class="op">&lt;=</span> <span class="op">(</span><span class="va">last_date</span> <span class="op">-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">weeks</a></span><span class="op">(</span><span class="fl">24</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">sales_valid</span> <span class="op">&lt;-</span> <span class="va">sales</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Date</span> <span class="op">&gt;</span> <span class="op">(</span><span class="va">last_date</span> <span class="op">-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">weeks</a></span><span class="op">(</span><span class="fl">24</span><span class="op">)</span><span class="op">)</span>,
                                <span class="va">Date</span> <span class="op">&lt;=</span> <span class="op">(</span><span class="va">last_date</span> <span class="op">-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">weeks</a></span><span class="op">(</span><span class="fl">8</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">sales_test</span> <span class="op">&lt;-</span> <span class="va">sales</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Date</span> <span class="op">&gt;</span> <span class="op">(</span><span class="va">last_date</span> <span class="op">-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">weeks</a></span><span class="op">(</span><span class="fl">8</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Now that the data is prepared we will create a preprocessing pipeline using the recipes package. This recipe will allow handling missing values and normalization of covariates - which is very important in neural network models. It also adds a few covariates that are recommended by the paper authors like <code>time_since_begining</code> and categoricals for month and week in the year.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">Weekly_Sales</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">sales_train</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_mutate.html" class="external-link">step_mutate</a></span><span class="op">(</span>
    time_since_begining <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span>
      time1 <span class="op">=</span> <span class="va">Date</span>, 
      time2 <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html" class="external-link">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">sales</span><span class="op">$</span><span class="va">Date</span><span class="op">)</span><span class="op">)</span>, 
      units <span class="op">=</span> <span class="st">"weeks"</span>
    <span class="op">)</span><span class="op">)</span>,
    date_week <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/week.html" class="external-link">week</a></span><span class="op">(</span><span class="va">Date</span><span class="op">)</span><span class="op">)</span>,
    date_month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html" class="external-link">month</a></span><span class="op">(</span><span class="va">Date</span><span class="op">)</span><span class="op">)</span>,
    IsHoliday <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">IsHoliday</span><span class="op">)</span>
  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_impute_median.html" class="external-link">step_impute_median</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"MarkDown"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_normalize.html" class="external-link">step_normalize</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html" class="external-link">all_numeric_predictors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="specifying-the-covariates">Specifying the covariates<a class="anchor" aria-label="anchor" href="#specifying-the-covariates"></a>
</h2>
<p>Like we said earlier, TFT allows encoding covariates differently in the architecture. There are 5 possible ways tft can treat columns in the dataset that we summarise below:</p>
<ul>
<li>
<strong>‘index’</strong>: is a single date column that specifies at which point in time the observation refers to. This is not directly used by the model itself, but is used internally to create rolling windows and order observations.</li>
<li>
<strong>‘key’</strong>: are groups of columns that identify a single time series. Keys are necessary if you are creating predictions for multiple time series in a single model. By default, ‘keys’ are also considered ‘static’ predictors by the model.</li>
<li>
<strong>‘static’</strong>: predictors are considered ‘static’ when they don’t vary over time, they are information from the time-series, like a region or a kind of product.</li>
<li>
<strong>‘unknown’</strong> are predictors that vary over time but we only know values observed for past observations. For example, you can use the daily temperature as a predictor, but you only know it for past observations.</li>
<li>
<strong>‘known’</strong> are predictors that vary over time and are known even for future observations. For example, the day of the week can be used as a predictor for a daily time series, and it’s known for every time step, no matter if it’s from past or future.</li>
</ul>
<p>To specify the role of each covariate in the model we use the <code><a href="../reference/tft_dataset_spec.html">tft_dataset_spec()</a></code> function. This interface has a similar intent as recipes (in tidymodels), ie. it allows you to reproduce the same preprocessing to a different dataset later - which is useful when you want to create forecasts.</p>
<p>Also part of the dataset specification is the history size the model will use to make predictions and the size of the horizon (ie how many time-steps ahead) we want to generate predictions. Consider the following diagram to represent the time series</p>
<div class="figure">
<img src="img/time-series.png" alt=""><p class="caption">Time series</p>
</div>
<p>tft feeds data to the model in slices that have a fixed history size, that we call <code>lookback</code> and a fixed number of timesteps ahead that we are calling <code>horizon</code>. Those are represented in the diagram below:</p>
<div class="figure">
<img src="img/slices.png" alt=""><p class="caption">Slices</p>
</div>
<p>Now lets create the tft dataset specification. We don’t need to manually specfy the <code>unknown</code> covariates as, unmentioned variables are automatically treated as such.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tft_dataset_spec.html">tft_dataset_spec</a></span><span class="op">(</span><span class="va">rec</span>, <span class="va">sales_train</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/tft_dataset_spec.html">spec_covariate_index</a></span><span class="op">(</span><span class="va">Date</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/tft_dataset_spec.html">spec_covariate_keys</a></span><span class="op">(</span><span class="va">Store</span>, <span class="va">Dept</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/tft_dataset_spec.html">spec_covariate_static</a></span><span class="op">(</span><span class="va">Type</span>, <span class="va">Size</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/tft_dataset_spec.html">spec_covariate_known</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"MarkDown"</span><span class="op">)</span>, <span class="va">time_since_begining</span>, 
                       <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"date_"</span><span class="op">)</span>, <span class="va">IsHoliday</span><span class="op">)</span></code></pre></div>
<p>The print method for <code>spec</code> shows useful information about the specification:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">spec</span>
<span class="co">#&gt; A <span style="color: #0000BB;">&lt;tft_dataset_spec&gt;</span> with:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; <span style="color: #BB0000;">✖</span> `lookback` and `horizon` are not set. Use `spec_time_splits()` </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ── Covariates: </span>
<span class="co">#&gt; <span style="color: #00BB00;">✔</span> `index`: Date</span>
<span class="co">#&gt; <span style="color: #00BB00;">✔</span> `keys`: &lt;list: Store, Dept&gt;</span>
<span class="co">#&gt; <span style="color: #00BB00;">✔</span> `static`: &lt;list: Type, Size&gt;</span>
<span class="co">#&gt; <span style="color: #00BB00;">✔</span> `known`: &lt;list: starts_with("MarkDown"), time_since_begining, starts_with("date_"), and IsHoliday&gt;</span>
<span class="co">#&gt; <span style="color: #BBBB00;">!</span> `unknown` is not set. Covariates that are not listed as other types are considered `unknown`.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Call `prep()` to prepare the specification.</span></code></pre></div>
<p>Here we see that we didn’t specify the <code>lookback</code> and <code>horizon</code>, so let’s add it to the spec. The <code>lookback</code> usually works like any other hyperparameter and we in general choose values between 10 and 200 depending on the time series period. Horizon is chosen to statisfy business needs, ie. if you want to have predictions for 4 weeks ahead, you should choose that.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">spec</span> <span class="op">&lt;-</span> <span class="va">spec</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/tft_dataset_spec.html">spec_time_splits</a></span><span class="op">(</span>lookback <span class="op">=</span> <span class="fl">52</span>, horizon <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></code></pre></div>
<p>We now execute <code>prep</code> to prepare the <code>spec</code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prep.html">prep</a></span><span class="op">(</span><span class="va">spec</span><span class="op">)</span>
<span class="va">spec</span>
<span class="co">#&gt; A <span style="color: #0000BB;">&lt;prepared_tft_dataset_spec&gt;</span> with:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; <span style="color: #00BB00;">✔</span> lookback = 52 and horizon = 4.</span>
<span class="co">#&gt; <span style="color: #00BB00;">✔</span> The number of possible slices is 256</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ── Covariates: </span>
<span class="co">#&gt; <span style="color: #00BB00;">✔</span> `index`: Date</span>
<span class="co">#&gt; <span style="color: #00BB00;">✔</span> `keys`: Store and Dept</span>
<span class="co">#&gt; <span style="color: #00BB00;">✔</span> `static`: Type and Size</span>
<span class="co">#&gt; <span style="color: #00BB00;">✔</span> `known`: MarkDown1, MarkDown2, MarkDown3, MarkDown4, MarkDown5, time_since_begining, date_week, date_month, and IsHoliday</span>
<span class="co">#&gt; <span style="color: #00BB00;">✔</span> `unknown`: Temperature, Fuel_Price, CPI, and Unemployment</span>
<span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Variables that are not specified in other types are considered `unknown`.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Call `transform()` to apply this spec to a different dataset.</span></code></pre></div>
<p>The print method now shows the name of all variables that will be used in the model and their role. Also shows information about the number of slices that will be used.</p>
</div>
<div class="section level2">
<h2 id="fitting-the-model">Fitting the model<a class="anchor" aria-label="anchor" href="#fitting-the-model"></a>
</h2>
<p>We will now fit our model. To that we first initialize the a model with:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/temporal_fusion_transformer.html">temporal_fusion_transformer</a></span><span class="op">(</span><span class="va">spec</span>, hidden_state_size <span class="op">=</span> <span class="fl">128</span><span class="op">)</span>
<span class="va">model</span>
<span class="co">#&gt; &lt;luz_module_generator&gt;</span></code></pre></div>
<p><code>model</code> is a luz module, thus you can use luz workflows to train the model. For an example, you can use the <code>lr_finder</code> function to find the best learning rate for your model.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">luz</span><span class="fu">::</span><span class="fu"><a href="https://mlverse.github.io/luz/reference/lr_finder.html" class="external-link">lr_finder</a></span><span class="op">(</span>
  <span class="va">model</span>, 
  <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">spec</span>, <span class="va">sales_train</span><span class="op">)</span>, 
  end_lr <span class="op">=</span> <span class="fl">1</span>,
  dataloader_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    batch_size <span class="op">=</span> <span class="fl">64</span>
  <span class="op">)</span>,
  verbose <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.15</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="Getting-started_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>This allows us to choose a learning rate. We will start with 1e-3. Let’s redefine the model now fixing the learning rate:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/temporal_fusion_transformer.html">temporal_fusion_transformer</a></span><span class="op">(</span><span class="va">spec</span>, hidden_state_size <span class="op">=</span> <span class="fl">128</span>,
                                     learn_rate <span class="op">=</span> <span class="fl">1e-3</span><span class="op">)</span></code></pre></div>
<p>We can then fit the model using <code>fit</code>. Since <code>model</code> is a luz module we are mainly calling <code>?fit.luz_module_generator</code> here, so all arguments apply.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fitted</span> <span class="op">&lt;-</span> <span class="va">model</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/fit.html">fit</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">spec</span>, <span class="va">sales_train</span><span class="op">)</span>,
    valid_data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">spec</span>, new_data <span class="op">=</span> <span class="va">sales_valid</span><span class="op">)</span>,
    epochs <span class="op">=</span> <span class="fl">100</span>,
    callbacks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
      <span class="fu">luz</span><span class="fu">::</span><span class="fu"><a href="https://mlverse.github.io/luz/reference/luz_callback_keep_best_model.html" class="external-link">luz_callback_keep_best_model</a></span><span class="op">(</span>monitor <span class="op">=</span> <span class="st">"valid_loss"</span><span class="op">)</span>,
      <span class="fu">luz</span><span class="fu">::</span><span class="fu"><a href="https://mlverse.github.io/luz/reference/luz_callback_early_stopping.html" class="external-link">luz_callback_early_stopping</a></span><span class="op">(</span>
        monitor <span class="op">=</span> <span class="st">"valid_loss"</span>, 
        patience <span class="op">=</span> <span class="fl">10</span>, 
        min_delta <span class="op">=</span> <span class="fl">0.001</span>
      <span class="op">)</span>
    <span class="op">)</span>,
    verbose <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fitted</span><span class="op">)</span></code></pre></div>
<p><img src="Getting-started_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<p>Once we are happy with the results of our model we can make predictions. The model we have trained can make predictions for 4 weeks ahead, but our test set has 8 weeks ahead. In order to validate the model, we are going to create 2 test sets and then combine the metrics. This is what the <code>rolling_predict</code> function does, so we don’t need to manually implement this:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rolling_predict.html">rolling_predict</a></span><span class="op">(</span>
  <span class="va">fitted</span>, 
  past_data <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">sales_train</span>, <span class="va">sales_valid</span><span class="op">)</span>,
  new_data <span class="op">=</span> <span class="va">sales_test</span>
<span class="op">)</span>
<span class="va">preds</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 3</span></span>
<span class="co">#&gt;   past_data           new_data           .pred            </span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>           </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> <span style="color: #949494;">&lt;tibble [208 × 16]&gt;</span> <span style="color: #949494;">&lt;tibble [16 × 16]&gt;</span> <span style="color: #949494;">&lt;tibble [16 × 3]&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> <span style="color: #949494;">&lt;tibble [208 × 16]&gt;</span> <span style="color: #949494;">&lt;tibble [16 × 16]&gt;</span> <span style="color: #949494;">&lt;tibble [16 × 3]&gt;</span></span></code></pre></div>
<p>The return value of <code>rolling_predict</code> is a tibble containing the <code>past_data</code>, <code>new_data</code> and <code>.pred</code> (predictions) for each slice that was made in the test data.</p>
<p>We can make a plot of predictions along with the historical data used for creating the predictions and the observed values.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">preds</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html" class="external-link">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>
    <span class="va">past_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="va">new_data</span>, <span class="va">.pred</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>.pred_at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">past_data</span><span class="op">$</span><span class="va">Date</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Date</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">Weekly_Sales</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">Weekly_Sales</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">.pred</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">.pred</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_grid</span><span class="op">(</span><span class="va">Store</span> <span class="op">+</span> <span class="va">Dept</span> <span class="op">~</span> <span class="va">.pred_at</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span>
<span class="co">#&gt; Warning: Removed 416 rows containing missing values (geom_point).</span>
<span class="co">#&gt; Warning: Removed 52 row(s) containing missing values (geom_path).</span></code></pre></div>
<p><img src="Getting-started_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
<p>To create predictions for future data, that we don’t yet have the target, we can use <code>predict</code>. For example:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">future_data</span> <span class="op">&lt;-</span> <span class="fu">walmartdata</span><span class="fu">::</span><span class="va">walmart_sales_test</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Store</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="va">Dept</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">92</span>, <span class="fl">95</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Store <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">Store</span><span class="op">)</span>, Dept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">Dept</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Date</span> <span class="op">&lt;=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">sales</span><span class="op">$</span><span class="va">Date</span><span class="op">)</span> <span class="op">+</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">weeks</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span>
  <span class="va">fitted</span>,
  new_data <span class="op">=</span> <span class="va">future_data</span>,
  past_data <span class="op">=</span> <span class="va">sales</span>
<span class="op">)</span></code></pre></div>
<p>We can then show the predictions in a plot:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sales</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Date</span> <span class="op">&gt;=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html" class="external-link">ymd</a></span><span class="op">(</span><span class="st">"2012-01-01"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="va">future_data</span>, <span class="va">pred</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Date</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">Weekly_Sales</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">Weekly_Sales</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">.pred</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">.pred</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_grid</span><span class="op">(</span><span class="va">Store</span> <span class="op">~</span> <span class="va">Dept</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span>
<span class="co">#&gt; Warning: Removed 16 rows containing missing values (geom_point).</span>
<span class="co">#&gt; Warning: Removed 4 row(s) containing missing values (geom_path).</span>
<span class="co">#&gt; Warning: Removed 172 rows containing missing values (geom_point).</span>
<span class="co">#&gt; Warning: Removed 43 row(s) containing missing values (geom_path).</span></code></pre></div>
<p><img src="Getting-started_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Daniel Falbel, Christophe Regouby.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
